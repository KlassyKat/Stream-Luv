<link rel="stylesheet" href="./styles/settingsSwitch.css">
<link rel="stylesheet" href="./styles/settings.css">
<link rel="stylesheet" href="./styles/scroll.css">
<link rel="stylesheet" href="./styles/customRadioButton.css">

<body onkeypress="submitEnter(event)" onkeyup="submitEnter(event)" onload="loadTwitchActions()">
    <div class="container">
        <header>
            Settings
        </header>
        <div class="support-wrapper">
            <div id="twitch-actions">
                <button onclick="twitchLogin()" id="twitch-login">
                    <!-- Twitch Logo -->
                    <svg height="70%" viewBox="0 0 207 240" version="1.1"
                        style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
                        <g>
                            <path
                                d="M52.181,193.856l-52.181,0l0,-152.14l44.229,-41.716l162.757,0l0,136.703l-57.153,57.153l-49.262,0l-48.39,45.953l0,-45.953Z"
                                style="fill:#9147ff;" />
                            <path
                                d="M86.006,146.171l-34.613,0l0,-131.049l138.465,0l0,95.895l-35.154,35.154l-34.655,0l-34.043,32.327l0,-32.327Z"
                                style="fill:#fff;" />
                            <rect x="103.493" y="51.65" width="17.132" height="50.751" style="fill:#9147ff;" />
                            <rect x="145.901" y="51.65" width="17.132" height="50.751" style="fill:#9147ff;" />
                        </g>
                    </svg>
                    <!-- Twitch Logo -->
                    <strong>Login</strong>
                </button>
                <div id="logout-wrapper">
                    <span id="user-name-display"></span>
                    <!-- Logout Icon -->
                    <span id="logout-icon-wrapper" onclick="twitchLogout()">
                        <svg width="20px" viewBox="0 0 32 27"
                            style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
                            <path
                                d="M11.806,17.502l0,6.638c0,0.531 0.211,1.04 0.587,1.416c0.375,0.376 0.885,0.587 1.416,0.587c4.229,-0 11.96,-0 16.188,-0c0.532,-0 1.041,-0.211 1.416,-0.587c0.376,-0.376 0.587,-0.885 0.587,-1.416c-0,-4.563 -0,-17.575 -0,-22.137c0,-0.532 -0.211,-1.041 -0.587,-1.416c-0.375,-0.376 -0.884,-0.587 -1.416,-0.587c-4.228,0 -11.959,0 -16.188,0c-0.531,-0 -1.041,0.211 -1.416,0.587c-0.376,0.375 -0.587,0.884 -0.587,1.416l0,6.741l3.542,0l-0,-4.04c-0,-0.18 0.072,-0.354 0.2,-0.482c0.127,-0.128 0.301,-0.199 0.482,-0.199c2.52,-0 9.226,-0 11.747,-0c0.181,-0 0.354,0.071 0.482,0.199c0.128,0.128 0.2,0.302 0.2,0.482c-0,2.683 -0,14.052 -0,16.734c-0,0.181 -0.072,0.354 -0.2,0.482c-0.128,0.128 -0.301,0.2 -0.482,0.2c-2.521,-0 -9.227,-0 -11.747,-0c-0.181,-0 -0.355,-0.072 -0.482,-0.2c-0.128,-0.128 -0.2,-0.301 -0.2,-0.482l-0,-3.936l-3.542,0Z" />
                            <rect x="7.575" y="10.32" width="14.328" height="5.607" />
                            <path d="M7.846,20.139l0,-14.031l-7.846,7.015l7.846,7.016Z" />
                        </svg>
                    </span>
                    <!-- <h4 id="logout-text" onclick="twitchLogout()">logout</h4> -->
                    <!-- Logout Icon -->
                </div>
            </div>
            <span></span>
            <button onclick="openInfoWindow()" id="app-info">
                <!-- <svg width="100%" height="100%" viewBox="0 0 299 299"
                    style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
                    <path
                        d="M149.362,0c82.435,0 149.362,66.927 149.362,149.362c0,82.435 -66.927,149.362 -149.362,149.362c-82.435,0 -149.362,-66.927 -149.362,-149.362c0,-82.435 66.927,-149.362 149.362,-149.362Zm0,23.898c69.246,0 125.465,56.219 125.465,125.464c0,69.246 -56.219,125.465 -125.465,125.465c-69.245,0 -125.464,-56.219 -125.464,-125.465c0,-69.245 56.219,-125.464 125.464,-125.464Z"
                        style="fill:#fff;" /><text x="75.974px" y="253.006px"
                        style="font-family:'Barlow-Bold', 'Barlow';font-weight:700;font-size:289.955px;fill:#fff;">?</text>
                </svg> -->
                <svg width="100%" height="100%" viewBox="0 0 32 32" >
                    <path
                        d="M6.221,9.33c-0,-1.259 0.404,-2.534 1.212,-3.826c0.808,-1.292 1.988,-2.362 3.538,-3.21c1.55,-0.848 3.359,-1.272 5.426,-1.272c1.921,0 3.617,0.355 5.088,1.064c1.47,0.708 2.607,1.672 3.408,2.891c0.802,1.219 1.203,2.544 1.203,3.975c-0,1.126 -0.229,2.114 -0.686,2.962c-0.457,0.848 -1,1.58 -1.63,2.196c-0.629,0.616 -1.759,1.653 -3.388,3.11c-0.451,0.411 -0.812,0.772 -1.084,1.083c-0.271,0.312 -0.473,0.597 -0.606,0.855c-0.132,0.258 -0.235,0.517 -0.308,0.775c-0.073,0.258 -0.182,0.712 -0.328,1.361c-0.252,1.378 -1.04,2.067 -2.365,2.067c-0.689,0 -1.269,-0.225 -1.739,-0.675c-0.47,-0.451 -0.705,-1.12 -0.705,-2.008c-0,-1.113 0.172,-2.077 0.516,-2.891c0.345,-0.815 0.802,-1.531 1.372,-2.147c0.569,-0.616 1.338,-1.348 2.305,-2.196c0.848,-0.742 1.461,-1.302 1.838,-1.679c0.378,-0.378 0.696,-0.799 0.954,-1.263c0.259,-0.463 0.388,-0.967 0.388,-1.51c0,-1.06 -0.394,-1.954 -1.183,-2.683c-0.788,-0.729 -1.805,-1.093 -3.05,-1.093c-1.458,-0 -2.531,0.367 -3.22,1.103c-0.689,0.735 -1.272,1.818 -1.749,3.249c-0.45,1.498 -1.305,2.246 -2.564,2.246c-0.742,0 -1.368,-0.261 -1.878,-0.785c-0.51,-0.523 -0.765,-1.09 -0.765,-1.699Zm9.699,21.783c-0.809,-0 -1.514,-0.262 -2.117,-0.786c-0.603,-0.523 -0.904,-1.255 -0.904,-2.196c-0,-0.834 0.291,-1.537 0.874,-2.106c0.583,-0.57 1.299,-0.855 2.147,-0.855c0.834,-0 1.537,0.285 2.106,0.855c0.57,0.569 0.855,1.272 0.855,2.106c0,0.928 -0.298,1.657 -0.894,2.187c-0.597,0.53 -1.286,0.795 -2.067,0.795Z"
                        style="fill:white" />
                </svg>
            </button>
            <span></span>
            <button onclick="openSupportWindow()" id="support-me">&#10084</button>
        </div>
        <div class="scroll-wrapper">
            <div class="menu-items">
                <!-- Auto Open Behavior -->
                <div class="setting-item">
                    <div class="setting-header">
                        <h2 class="setting-label"><strong>Auto Open Behavior</strong></h2>
                        <p>What window type StreamLuv will open streams in, based on the settings.</p>
                    </div>

                    <form class="setting-form" id="auto-open-behavior">

                        <label class="input-container">Default Browser Window
                            <input type="radio" id="auto-browser-open" onchange="changeAutoOpen(this.value)" name="open-type"
                                value="browser">
                            <span class="custom-rb"></span>
                        </label>

                        <label class="input-container">StreamLuv Window
                            <input type="radio" id="auto-stream-luv-open" onchange="changeAutoOpen(this.value)"
                                name="open-type" value="stream-luv">
                            <span class="custom-rb"></span>
                        </label>
                        <span class="stream-luv-window-info">?</span>
                        <label class="input-container">Only Auto Collection Opens In StreamLuv
                            <input type="radio" id="auto-collection-open" onchange="changeAutoOpen(this.value)"
                                name="open-type" value="auto-collect">
                            <span class="custom-rb"></span>
                        </label>
                    </form>
                </div>

                <!-- Link Type Setting -->
                <div class="setting-item">
                    <div class="setting-header">
                        <h2 class="setting-label"><strong>Tile Link</strong></h2>
                        <p>How the clickable link opens streams. Either in a <span>StreamLuv Window</span> or in your main browser.</p>
                    </div>

                    <form class="setting-form" id="link-type">
                        <label class="input-container">StreamLuv Window
                            <input type="radio" id="stream-luv-open" onchange="changeLinkType(this.value)"
                                name="open-type" value="stream-luv">
                            <span class="custom-rb"></span>
                        </label>
                        <span class="stream-luv-window-info">?</span>

                        <label class="input-container">Default Browser Window
                            <input type="radio" id="browser-open" onchange="changeLinkType(this.value)" name="open-type"
                                value="browser">
                            <span class="custom-rb"></span>
                        </label>
                    </form>
                </div>

                <!-- Open on startup -->
                <div class="setting-item">
                    <div class="setting-header">
                        <h2 class="setting-label"><strong>Open on Startup</strong></h2>
                        <p>When your computer starts so does StreamLuv.</p>
                    </div>
                    <div class="switch-wrapper">
                        <label class="switch">
                            <input type="checkbox" id="auto-open-switch" onclick="setAutoOpen(this)">
                            <span class="slider"></span>
                        </label>
                        <span id="auto-open-state">Off</span>
                    </div>
                </div>

                <!-- Start Streams Muted -->
                <div class="setting-item">
                    <div class="setting-header">
                        <h2 class="setting-label"><strong>Start Streams Muted</strong></h2>
                        <p>Streams start up muted. (<strong>StreamLuv Windows Only</strong>)</p>
                    </div>
                    <div class="switch-wrapper">
                        <label class="switch">
                            <input type="checkbox" id="start-muted-switch" onclick="setStartMuted(this)">
                            <span tabindex="6" class="slider"></span>
                        </label>
                        <span id="start-muted-state">Off</span>
                    </div>
                </div>
                
                <!-- Mute Toggle Shortcut -->
                <div class="setting-item">
                    <div class="setting-header">
                        <h2 class="setting-label"><strong>Mute Shortcut</strong></h2>
                        <p>Set a hotkey to toggle the mute of the most recently active StreamLuv Window</p>
                    </div>
                    <div class="set-shortcut-wrapper">
                        <label class="shortcut-label "for="toggle-mute">Toggle Mute:</label>
                        <input onclick="focusShortcutInput()" onblur="blurShortcutInput()" onkeypress="return false" id="toggle-mute-input" name="toggle-mute">
                    </div>
                </div>

                <!-- Auto Theater -->
                <div class="setting-item">
                    <div class="setting-header">
                        <h2 class="setting-label"><strong>Auto Theater</strong></h2>
                        <p>Streams start in theater view.</p>
                    </div>
                    <div class="switch-wrapper">
                        <label class="switch">
                            <input type="checkbox" id="auto-theater-switch" onclick="setAutoTheater(this)">
                            <span tabindex="9" class="slider"></span>
                        </label>
                        <span id="auto-theater-state">Off</span>
                    </div>
                </div>

                <!-- <div class="setting-item">
                <div class="stream-toggle">
                    <label class="switch">
                        <input type="checkbox" onclick="setting()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div> -->
            </div>
        </div>
        <footer>
            <button class="done-btn" onclick="closeWindow()">Done</button>
        </footer>
    </div>
</body>

<script>
    const {
        ipcRenderer
    } = require('electron');

    let streamInput = document.querySelector(".url-input");
    let settings = {};
    ipcRenderer.send('get-settings');
    ipcRenderer.on('send-settings', (e, data) => {
        settings = JSON.parse(data);
        console.log(settings.startmuted);
        setStates();
    })


    //Login
    ipcRenderer.send('twitch-logout', "get-user");
    loadTwitchActions();

    function loadTwitchActions() {
        console.log('load twitch actions')
        let loginState = localStorage.getItem('user');
        if (loginState) {
            document.getElementById('twitch-login').style.display = 'none';
            document.getElementById('logout-wrapper').style.display = 'flex';
        } else {
            document.getElementById('logout-wrapper').style.display = 'none';
            document.getElementById('twitch-login').style.display = 'flex';
        }

        document.getElementById('user-name-display').textContent = loginState;
    }


    function twitchLogin() {
        ipcRenderer.send('twitch-login');
    }

    ipcRenderer.on('logged-in', () => {
        ipcRenderer.send('twitch-logout', "get-user");
    })

    ipcRenderer.on('user-name', (e, data) => {
        console.log(data)
        if (data) {
            localStorage.setItem('user', data);
        } else {
            localStorage.removeItem('user');
        }
        loadTwitchActions();
    })

    ipcRenderer.on('logout-success', () => {
        localStorage.removeItem('user');
    })

    function twitchLogout() {
        ipcRenderer.send('twitch-logout', "logout");
    }


    //Close Window
    function closeWindow() {
        ipcRenderer.send("close-setting-window");
    }

    //Setting Window shortcuts
    function submitEnter(e) {
        if (e.keyCode == 13) { //Enter Key
            applySettings();
        } else if (e.keyCode == 27) { //Esc Key
            closeWindow();
        }
    }

    //SECTION Set setting states
    let autoBrowser = document.getElementById('auto-browser-open');
    let autoStreamLuv = document.getElementById('auto-stream-luv-open');
    let autoCollection = document.getElementById('auto-collection-open');

    let browserOpen = document.getElementById('browser-open');
    let streamLuvOpen = document.getElementById('stream-luv-open');

    let autoOpenSwitch = document.getElementById('auto-open-switch');
    let autoOpenState = document.getElementById('auto-open-state');

    let startMutedSwitch = document.getElementById('start-muted-switch');
    let startMutedState = document.getElementById('start-muted-state');

    let setSpan = document.getElementById('toggle-mute-input');
    let shortcutVal = settings.muteshortcut || ['Ctrl', '\''];
    let oldShortcut = [];

    let autoTheaterSwitch = document.getElementById('auto-theater-switch');
    let autoTheaterState = document.getElementById('auto-theater-state');


    function setStates() {
        //Auto Open Behavior
        if(settings.autoopentype == 'browser') {
            autoBrowser.checked = true;
        } else if(settings.autoopentype == 'stream-luv') {
            autoStreamLuv.checked = true;
        } else if(settings.autoopentype == 'auto-collect') {
            autoCollection.checked = true;
        } else {
            autoBrowser.checked = true;
        }
        //Link Type
        if (settings.linkType == 'browser') {
            browserOpen.checked = true;
        } else if (settings.linkType == 'stream-luv') {
            streamLuvOpen.checked = true;
        } else {
            browserOpen.checked = true;
        }

        //Open on startup
        if (settings.autoopen) {
            autoOpenSwitch.checked = true;
            autoOpenState.innerHTML = 'On';
        } else {
            autoOpenSwitch.checked = false;
            autoOpenState.innerHTML = 'Off';
        }

        //Start Muted
        if (settings.startmuted) {
            startMutedSwitch.checked = true;
            startMutedState.innerHTML = 'On';
        } else {
            startMutedSwitch.checked = false;
            startMutedState.innerHTML = 'Off';
        }

        //Mute Shortcut
        setSpan.value = shortcutVal.join('+');

        //Auto Theater
        if (settings.autotheater) {
            autoTheaterSwitch.checked = true;
            autoTheaterState.innerHTML = 'On';
        } else {
            autoTheaterSwitch.checked = false;
            autoTheaterState.innerHTML = 'Off';
        }
    }
    

    //SECTION Setting controls
    //Auto Open Behavior
    function changeAutoOpen(type) {
        console.log(type)
        settings.autoopentype = type;
        saveSettings();
    }

    //Link Type
    function changeLinkType(type) {
        console.log(type);
        settings.linkType = type;
        saveSettings();
    }

    //Set to open on startup
    function setAutoOpen(e) {
        console.log(e.checked);
        if (e.checked) {
            settings.autoopen = true;
            autoOpenState.innerHTML = 'On';
        } else {
            settings.autoopen = false;
            autoOpenState.innerHTML = 'Off';
        }
        ipcRenderer.send('set-startup-open', e.checked);
        saveSettings();
    }

    //Set to start muted
    function setStartMuted(e) {
        console.log(e.checked);
        if (e.checked) {
            settings.startmuted = true;
            startMutedState.innerHTML = 'On';
        } else {
            settings.startmuted = false;
            startMutedState.innerHTML = 'Off';
        }
        ipcRenderer.send('set-start-muted', e.checked);
        saveSettings();
    }

    //Mute Shortcut
    function focusShortcutInput() {
        shortcutVal = [];
        document.addEventListener("keydown", processShortcut);
        document.addEventListener("keyup", confirmShortcut);
    }

    function processShortcut(e) {
        e.preventDefault();
        console.log(e);
        let newKey = e.key;
        //Handle edge cases
        if(e.code == 'Space') {
            newKey = e.code;
        } else if(e.key == 'Control') {
            newKey = 'Ctrl';
        } else if(e.key.indexOf('Arrow') > -1) {
            newKey = e.key.slice(5);
        }

        if(newKey.length == 1) {
            newKey = newKey.toUpperCase();
        }
        if(!shortcutVal.includes(newKey)) {
            shortcutVal.push(newKey);
        }
        setSpan.value = shortcutVal.join('+');
    }

    function confirmShortcut() {
        let shortcutCheck = shortcutVal.filter(key => {
            if(key != 'Ctrl' && key != 'Shift' && key != 'Alt') {
                return true;
            } else {
                return false
            }
        })
        if(shortcutCheck.length == 0) {
            setSpan.value = oldShortcut.join('+');
        } else {
            settings.muteshortcut = shortcutVal;
            oldShortcut = shortcutVal;
            saveSettings();
            ipcRenderer.send('new-mute-shortcut', shortcutVal);
        }
        setSpan.blur();
    }

    function blurShortcutInput() {
        document.removeEventListener("keydown", processShortcut);
        document.addEventListener("keyup", confirmShortcut);
    }

    //Auto Theater
    function setAutoTheater(e) {
        if(e.checked) {
            settings.autotheater = true;
            autoTheaterState.innerHTML = 'On';
        } else {
            settings.autotheater = false;
            autoTheaterState.innerHTML = 'Off';
        }
        ipcRenderer.send('set-auto-theater', e.checked);
        saveSettings();
    }

    function saveSettings() {
        ipcRenderer.send('save-settings', settings);
    }


    function openSupportWindow() {
        ipcRenderer.send('open-support-window');
    }
    function openInfoWindow() {
        ipcRenderer.send('open-info-window');
    }


</script>